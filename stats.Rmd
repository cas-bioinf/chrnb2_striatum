---
title: "Additional statistical analysis"
output: html_notebook
---

```{r setup}
library(readxl)
library(here)
library(rstanarm)
library(brms)
library(MASS)
library(tidyverse)
options(mc.cores = parallel::detectCores())
```

# Head dippings

```{r}
head_c1 <- read_excel(here("private_data", "Hole board cohort 1.xlsx"), 
                      sheet = "Number of head dippings",
                      range = "A4:B20") %>% 
  rename(mouse = ctrl, n_dippings = `Total number of head dippings`) %>% 
  filter(!(mouse %in% c("average","mt") )) %>% 
  mutate(group = c(rep("ctrl", 10), rep("mt", 4)), cohort = "1")

head_c2 <- read_excel(here("private_data", "Hole board test_cohort 2.xlsx"), 
                      sheet = "Number of head dippings",
                      range = "A4:E25") %>% 
  select(-Jakub, -Revan, -ratio) %>%
  rename(mouse = ctrl, n_dippings = `Re-scoring Helena`) %>% 
  filter(!(mouse %in% c("average","mt") ), !is.na(n_dippings)) %>% 
  mutate(group = c(rep("ctrl", 6), rep("mt", 11)), cohort = "2")

head_all <- rbind(head_c1, head_c2)
```

```{r}
fit_head_pois_stan <- stan_glm(n_dippings ~ group, data = head_all, family = "poisson")
pp_check(fit_head_pois_stan, plotfun = "stat_grouped", stat = "sd", group = "group")
```

```{r}
fit_head_nb_stan <- stan_glm.nb(n_dippings ~ group, data = head_all)
pp_check(fit_head_nb_stan, plotfun = "stat_grouped", stat = "sd", group = "group")
bayesplot::ppc_stat_grouped(head_all$n_dippings, posterior_predict(fit_head_nb_stan, summary = FALSE), group = interaction(head_all$cohort, head_all$group), stat = "mean")
```
```{r}
summary(fit_head_nb_stan, probs = c(0.025,0.975))
sum_head_nb_stan <- summary(fit_head_nb_stan, probs = c(0.025,0.975))
ci_head_nb_stan <- sum_head_nb_stan["groupmt", c("2.5%", "97.5%")]
#ci_head_nb_stan
```
```{r}
  exp(ci_head_nb_stan)
```
```{r}
fit_head_nb <- glm.nb(n_dippings ~ group, data = head_all)
summary(fit_head_nb)
exp(confint(fit_head_nb))
```
# Nest building


We will take the total amount as 3 for all cohorts, although cohort 1 had 2.8, because no mouse in cohort 1 achieved near 2.8.

```{r}
read_single_condition_nest <- function(column, cohort) {
  control_range = paste0(column, "4:", column, "13")
  control <- read_excel(here("private_data", "Nest building cohort 1-4.xlsx"), sheet = "Sheet1",
                        range = control_range, col_names = "amount", col_types = "numeric") %>%
    mutate(group = "control")

  cre_range = paste0(column, "15:", column, "25")
  cre <- read_excel(here("private_data", "Nest building cohort 1-4.xlsx"), sheet = "Sheet1",
                        range = cre_range, col_names = "amount", col_types = "numeric") %>%
    mutate(group = "cre")
  
  rbind(control, cre) %>%
    filter(!is.na(amount)) %>%
    mutate(cohort = !!cohort)
}
nest <- rbind(
  read_single_condition_nest("B", 1),
  read_single_condition_nest("E", 2),
  read_single_condition_nest("H", 3),
  read_single_condition_nest("K", 4)
) %>% mutate(
  proportion = amount/3
)

```



```{r}
#fit_nest_inf_beta <- brm(proportion ~ group, data = nest, family = zero_one_inflated_beta())

fit_nest_inf_beta <- brm(bf(proportion ~ group, zoi ~ group), data = nest, family = zero_one_inflated_beta())


pp_check(fit_nest_inf_beta, nsamples = 30)
pp_check(fit_nest_inf_beta, type = "stat_grouped", stat = "sd", group = "group", nsamples = 4000)
pred_nest <- posterior_predict(fit_nest_inf_beta, summary = FALSE)
bayesplot::ppc_stat_grouped(nest$proportion, pred_nest, group = nest$cohort, stat = "mean")
bayesplot::ppc_bars_grouped(as.numeric(nest$proportion == 0) , matrix(as.numeric(pred_nest == 0), nrow = nrow(pred_nest), ncol = ncol(pred_nest)), group = nest$cohort)
bayesplot::ppc_bars_grouped(as.numeric(nest$proportion == 0) , matrix(as.numeric(pred_nest == 0), nrow = nrow(pred_nest), ncol = ncol(pred_nest)), group = nest$group)
bayesplot::ppc_stat_grouped(nest$proportion, pred_nest, group = nest$cohort, stat = "sd")
bayesplot::ppc_stat_grouped(nest$proportion, pred_nest, group = interaction(nest$group, nest$cohort), stat = "mean")

```

```{r}
fit_nest_inf_beta
```
```{r}
preds_nest <- posterior_epred(fit_nest_inf_beta, newdata = data.frame(group = c("control", "cre")))
diffs <- preds_nest[,2] - preds_nest[, 1]
quantile(diffs, c(0.025,0.975))
mean(diffs > 0)
```
```{r}
nest %>% group_by(group) %>% summarise(median(amount))
```

```{r}
nest %>% ggplot(aes( x = group, y = amount)) + geom_jitter(width = 0.4, height = 0)
```

# Forced swimming

```{r}
swim <- read_excel(here("private_data", "FST cohort 1-4.xlsx"), sheet = "Sheet1", range = "A2:B34") %>% pivot_longer(everything(), names_to = "group", values_to = "time") %>% filter(!is.na(time))
```

```{r}
swim %>% ggplot(aes(x = group, y = time)) + geom_jitter(width = 0.3, height = 0)

swim %>% ggplot(aes(x = time)) + geom_density() + facet_wrap(~group, ncol = 1)

```
```{r}
fit_swim_stan <- brm(time ~ group, data = swim, family = "lognormal")
pp_check(fit_swim_stan, type = "stat_grouped", stat = "sd", group = "group", nsamples = 4000)
pp_check(fit_swim_stan, type = "dens_overlay", nsamples = 30)


fit_swim_stan
```
```{r}
fit_swim_stan_gamma <- brm(time ~ group, data = swim, family = Gamma(link = "log"))
pp_check(fit_swim_stan_gamma, type = "stat_grouped", stat = "sd", group = "group", nsamples = 4000)
pp_check(fit_swim_stan_gamma, type = "dens_overlay", nsamples = 30)
fit_swim_stan_gamma

```
```{r}
fit_swim_glm <- glm(time ~ group, family = Gamma(link = "log"), data = swim)
summary(fit_swim_glm)
exp(confint(fit_swim_glm))
```
```{r}
fit_swim_glm_2 <- glm(time ~ group, family = gaussian(link = "log"), data = swim)
summary(fit_swim_glm_2)
exp(confint(fit_swim_glm_2))
```


# Examining time

```{r}
examining_raw <- read_excel(here("private_data", "Examining times cohort 1 to 4.xlsx"), sheet = "Sheet1", range = "A2:K34", na = c("", "missing video?")) %>%    
  transmute(cre.object = `examining object...3`,
            cre.mouse = `examining mouse...2`,
            control.object = `examining object...10`,
            control.mouse = `examining mouse...9`,
            cre.id = cre,
            control.id = ctrl)

examining_longer_spec <- data.frame(.name = c("cre.id", "control.id", "cre.object", "control.object", "cre.mouse", "control.mouse"), .value = rep(c("id", "object", "mouse"), each = 2), group = rep(c("cre", "control"), 3)
                             )


examining <- examining_raw  %>%
  pivot_longer_spec(examining_longer_spec) %>%
  filter(!is.na(object), !is.na(mouse)) %>%
  mutate(mo_ratio = mouse/object)
```
```{r}
examining %>% ggplot(aes(x = group, y = object)) + geom_jitter(width = 0.3, height = 0)

examining %>% ggplot(aes(x = object)) + geom_density() + facet_wrap(~group, ncol = 1)

```
```{r}
fit_object_stan <- brm(object ~ group, data = examining, family = "lognormal")
pp_check(fit_object_stan, type = "stat_grouped", stat = "sd", group = "group", nsamples = 4000)
pp_check(fit_object_stan, type = "dens_overlay", nsamples = 30)


fit_object_stan
```
```{r}
fit_object_stan_gamma <- brm(object ~ group, data = examining, family = Gamma(link = "log"))
pp_check(fit_object_stan_gamma, type = "stat_grouped", stat = "sd", group = "group", nsamples = 4000)
pp_check(fit_object_stan_gamma, type = "dens_overlay", nsamples = 30)
fit_object_stan_gamma

```


```{r}
fit_object <- glm(object ~ group, data = examining, family = Gamma(link = "log"))
summary(fit_object)
exp(confint(fit_object))
```

```{r}
fit_object_2 <- glm(object ~ group, data = examining, family = gaussian(link = "log"))
summary(fit_object_2)
exp(confint(fit_object_2))

```
## Mouse

```{r}
examining %>% ggplot(aes(x = group, y = mouse)) + geom_jitter(width = 0.3, height = 0)

examining %>% ggplot(aes(x = mouse)) + geom_density() + facet_wrap(~group, ncol = 1)
```

```{r}
examining <- examining %>% mutate(mouse = if_else(mouse == 0,0.001, mouse))
```

```{r}
fit_mouse <- glm(mouse ~ group, data = examining, family = Gamma(link = "log"))
summary(fit_mouse)
exp(confint(fit_mouse))
```

```{r}
fit_mouse_2 <- glm(mouse ~ group, data = examining, family = gaussian(link = "log"))
summary(fit_mouse_2)
exp(confint(fit_mouse_2))

```

## Ratio

```{r}
examining_longer <- examining %>% select(-mo_ratio) %>%
  pivot_longer(one_of(c("mouse", "object")), names_to = "type", values_to = "time") %>%
  


fit_mo_ratio_long <- glm(time ~ group * type, data = examining_longer, family = Gamma(link = "log"))
summary(fit_mo_ratio_long)
exp(confint(fit_mo_ratio_long))
```

log mo_Ratio in control:
I - (I + typeobject) = -typeobject

log mo_Ratio in treatment:
(I + groupcre) - (I + groupcre + typeobject + groupcre:typeobject) = -typeobject - groupcre:typeoboject

Ratio of ratios treatment/control:
(-typeboject - groupcre:typeobject) - (-typeobject) = -groupcre:typeobject

```{r}
exp(-confint(fit_mo_ratio_long)["groupcre:typeobject",])
```


